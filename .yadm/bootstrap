#!/usr/bin/env ruby

require_relative 'bootstrap_lib'

require 'optparse'
require 'pathname'

options = {}
OptionParser.new do |opts|
  opts.on('-v', '--[no-]verbose', 'Run verbosely') do |v|
    options[:verbose] = v
  end
end.parse!

Bootstrap.run(options) do
  category 'yadm' do
    action 'install envtpl via pip' do
      install('envtpl', method: :pip, options: ['--user'])
    end
  end

  category 'emacs' do
    action 'clone doom-emacs' do
      clone 'git@gitlab.com:/BrightOne/doom-emacs.git', '~/.emacs.d.doom'
    end
    action 'clone spacemacs' do
      clone 'https://github.com/syl20bnr/spacemacs', '~/.emacs.d.spacemacs'
    end
    action 'set doom-emacs as default' do
      execute 'switch-emacs doom'
    end
  end

  category 'passwords' do
    action 'clone passwords' do
      clone 'git@gitlab.com:BrightOne/passwords.git', '~/.password-store'
    end
  end

  category 'zsh' do
    category 'zplugin' do
      action 'install zplugin' do
        if Dir.exist?(File.expand_path('~/.zplugin'))
          debug 'zplugin already installed'
        else
          url = 'https://raw.githubusercontent.com/zdharma/zplugin/master/doc/install.sh)'
          install(url, method: :script)
        end
      end
      action 'initialize zplugin' do
        execute 'zsh -c exit'
      end
      category 'prompts' do
        dir = 'https--github.com--sorin-ionescu--prezto--trunk--modules'
        path = File.expand_path("~/.zplugin/snippets/#{dir}/prompt/functions")
        action 'remove problematic prompts' do
          problematic = %w[agnoster powerlevel9k powerline pure]
          Pathname(path)
            .children
            .select { |f| /prompt_(#{problematic.join('|')})_setup/ =~ f.to_s }
            .each(&:delete)
        end
        action 'fix steeef theme' do
          execute "sed -i \"93 s/} '$/}‚ùØ '/\" #{path}/prompt_steeef_setup"
        end
      end
    end
  end
end
